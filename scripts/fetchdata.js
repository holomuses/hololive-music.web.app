/* eslint-disable @typescript-eslint/ban-ts-comment */
// @ts-check
import { readFile, writeFile } from 'node:fs/promises';
import { dirname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { parseProjectToml } from './config.js';
import { getDominantColor, getThumbnail } from './utils.js';
import { fetchPlaylist, fetchVideos, isAutoGeneratedVideo } from './youtube.js';

/**
 * @param {string | undefined} tomlPath
 */
const main = async (tomlPath) => {
	// @ts-ignore
	const __dirname = dirname(fileURLToPath(import.meta.url));
	const _tomlPath =
		tomlPath === undefined ? resolve(__dirname, '..', 'project.toml') : resolve(tomlPath);

	const projectToml = await readFile(_tomlPath, 'utf8');
	const project = parseProjectToml(projectToml);

	const ignoreIds = new Set(project.ignore.map(({ id }) => id) ?? []);
	/** @type {Record<string, string[]>} */
	const idTagMap =
		project.video?.length > 0
			? Object.fromEntries(project.video.map(({ id, tags }) => [id, tags]))
			: {};

	/** @type {Record<string, import('../src/types').VideoInfo>} */
	const videos = {};

	for (const playlist of project.playlist) {
		const videosInPlaylist = await fetchPlaylist(playlist.id);
		const tags = playlist.tags ?? [];
		videosInPlaylist.forEach(({ resourceId }) => {
			if (resourceId.videoId == null) return;
			idTagMap[resourceId.videoId] = tags;
		});
	}

	if (project.video?.length > 0) {
		const videosRes = await fetchVideos(Object.keys(idTagMap));
		await Promise.all(
			videosRes.map(async (res) => {
				if (res.status?.privacyStatus !== 'public') return;
				const thumbnail = res.snippet.thumbnails && getThumbnail(res.snippet.thumbnails);
				const tags = [...new Set(idTagMap[res.id])] ?? [];
				if (thumbnail == null) return;
				if (videos[res.id] != null) {
					videos[res.id].tags =
						videos[res.id].tags == null ? tags : [...new Set([...videos[res.id].tags, ...tags])];
				} else {
					videos[res.id] = {
						title: res.snippet.title,
						id: res.id,
						thumbnail,
						color: await getDominantColor(thumbnail.url),
						squareThumbnail: isAutoGeneratedVideo(res.snippet?.description),
						description: res.snippet?.description,
						tags
					};
				}
			})
		);
	}

	await writeFile(
		resolve(__dirname, '..', 'src', 'resources.json'),
		JSON.stringify({
			project: project.project,
			videos: Object.values(videos)
		})
	);
};

main(process.argv[2])
	.then(() => process.exit())
	.catch((e) => {
		console.error(e);
		process.exit(1);
	});
